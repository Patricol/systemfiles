#check over this so I can upload it as a first version before editing it a lot.
#CHECK THIS NOTE SYNCED BEFORE REFORMATTING
also ensure that the systemfiles repo is up to date etc.
and check that duplicati is working http://localhost:8200

adjust these notes etc. so I have a nice list of everything I need to do in preparation of doing a full reinstall like this.

git clone -b arch --bare https://github.com/Patricol/systemfiles.git /home/secure/systemfiles-repo
alias sysg='git --git-dir=/home/secure/systemfiles-repo/ --work-tree=/'
		sysg config --local status.showUntrackedFiles no
		sysg checkout

get dotfiles setup so they contain a list of installed packages, both explicit and asdeps; so I can not have to maintain any list here etc.
actually, separate system repo that contains those lists of packages and also any system files that the installation process needs to manually edit. that would also be a good place to store this installation stuff as an actual script. should definitely be tracking changes to it; so it really needs to go in a github repo eventually.

Even though using an installer for Arch is tempting as a way to abstract away the hardware and any partitioning etc, I should stick with manual installs so that I can be certain of exactly what has or has not been done to the system. That makes troubleshooting issues much easier, etc.


move excess files from /home folders onto nas before doing this; if needed/desired. probably also delete cache folders.
also sudo baobab to check other folders for important things. VM images can be created outside of /home automatically etc.
also should probably close all programs so chrome etc aren't in use.
make backups like:
sudo tar -cvf /arch-homes.tar /home/
extract them like:
sudo tar --same-owner -xvpf arch-homes.tar


boot into archiso login.

Follow https://wiki.archlinux.org/index.php/Installation_guide or install.txt to match this to hardware etc. if needed.

#RUN WITH ONLY ONE HDD CONNECTED, AND ONLY IF ENTIRE HDD CAN BE USED.
#time how long this takes, to aid future decisions about when it's faster to nuke from orbit.
ping -c 1 1.1.1.1
timedatectl set-ntp true
fdisk -l
parted /dev/sdx
select /dev/sdx
#CHECK THIS NOTE SYNCED BEFORE FORMATTING
mklabel gpt
mkpart ESP fat32 1MiB 551MiB
set 1 esp on
mkpart primary ext4 551MiB 100%
quit
mkfs.fat -F32 /dev/sdx1
mkfs.ext4 /dev/sdx2
mount /dev/sdx2 /mnt
pacstrap /mnt base base-devel
genfstab -L /mnt >> /mnt/etc/fstab
#genfstab -U /mnt >> /mnt/etc/fstab
arch-chroot /mnt
ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime
hwclock --systohc
sed -i '/^#en_US.UTF-8 UTF-8/s/^#//' /etc/locale.gen
sed -i '/^#en_US ISO-8859-1/s/^#//' /etc/locale.gen
locale-gen
echo 'LANG=en_US.UTF-8' | tee -a /etc/locale.conf
echo 'fcdcbda' > /etc/hostname
echo -e '127.0.0.1 localhost\n::1 localhost\n127.0.1.1 fcdcbda.localdomain fcdcbda' | tee -a /etc/hosts
#COMPLETE https://wiki.archlinux.org/index.php/Network_configuration HERE
mkinitcpio -p linux
passwd
#NOTE: for all pacman installs, if a package is already installed, (as a dependency for something else,) run "pacman -D --asexplicit package_name" to mark it as an explicit install.
#DON'T USE "pacman -S --asexplicit"; as that also marks any automatically added dependencies as explicitly installed.
pacman -Syu intel-ucode refind-efi
#above assuming you have an intel processor
mkdir /boot/efi
exit
mount /dev/sdx1 /mnt/boot/efi
#Your kernel and initramfs must reside on a file system that rEFInd can read. (Unencrypted Ext4, Btrfs, NTFS, FAT, etc.)
refind-install --root /mnt
umount -R /mnt
poweroff
#remove install media

#power on
#login as root
timedatectl set-ntp true
systemctl --now enable dhcpcd.service
groupadd patrick
useradd -m -g patrick -s /bin/bash patricol
useradd -m -g patrick -s /bin/bash work
passwd patricol
passwd work
groupadd -r sudo
sed -i '/^# %sudo\tALL=(ALL) ALL/s/^# //' /etc/sudoers
usermod -aG sudo patricol
exit
#login as patricol
sudo passwd -l root
sudo pacman -Syu openssh
echo -e 'PermitRootLogin no\nAllowGroups ssh' | sudo tee -a /etc/ssh/sshd_config
sudo groupadd -r ssh
sudo usermod -aG ssh patricol
sudo systemctl --now enable sshd.service
ip address
exit

#login as patricol (can use ssh this time if desired.)
sudo pacman -Syu pigz pacman-contrib git vim
sudo -i
fallocate -l 16G /swapfile
#match size above to RAM installed.
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
exit

git clone https://aur.archlinux.org/yay.git
cd yay
makepkg -sci
cd ..
rm -rf ./yay/


#HARDWARE SPECIFIC SECTION
sudo mkinitcpio -p linux
#handle any warnings thrown by that last command. can safely ignore missing aic94xx, wd719x, and smsmdtv
yay -Syu vulkan-intel
#to support vulkan on integrated graphics.
#maybe https://wiki.archlinux.org/index.php/Intel_graphics#Enable_GuC_.2F_HuC_firmware_loading
sudo systemctl --now enable fstrim.timer
#schedules SSD TRIM
yay -Syu gpm
sudo systemctl --now enable gpm.service

#for full unicode coverage https://en.wikipedia.org/wiki/Unicode_font#Comparison_of_fonts
yay -Syu bdf-unifont noto-fonts noto-fonts-emoji adobe-source-code-pro-fonts ttf-roboto freetype2 adobe-source-sans-pro-fonts
yay -Syu ttf-unifont ttf-everson-mono ttf-roboto-mono nerd-fonts-complete

yay -Syu xorg-server xorg-xinit xorg-xrandr xorg-xdpyinfo xorg-xinput
yay -Syu i3-gaps rofi
yay -Syu --asdeps perl-anyevent-i3 perl-json-xs
yay -Syu i3lock-color-git
echo 'exec i3' | tee -a ~/.xinitrc
#exec startx for gui

yay -Syu chromium docker docker-compose bash-completion wget curl readline p7zip gnupg keychain pam sshfs exfat-utils ntfs-3g cifs-utils qemu libvirt virt-manager ovmf polkit tmux traceroute unzip tree fortune-mod redshift nitrogen expac atom remmina ffmpeg gpa nemo vlc rclone python python2 python-pip python2-pip gparted deluge filezilla meld neofetch youtube-dl veracrypt quassel-client inkscape gimp okular pycharm-community-edition gpick libreoffice-fresh simple-scan shotwell gucharmap gnome-clocks gnome-mines audacity cheese baobab cherrytree wireshark-gtk gnome-sound-recorder handbrake calibre digikam qpdfview avidemux-qt thefuck mcomix caprine gnome-calculator gnome-screenshot kitty gnome-disk-utility file-roller gnome-system-monitor gnome-keyring arc-gtk-theme adapta-gtk-theme scrot pavucontrol powerline udiskie cowsay blueman feh stress htop expect libu2f-host yubico-pam ranger gwenview wol xclip xdotool fdupes qt5ct yubikey-personalization-gui x11-ssh-askpass rsync
#sudo pacman -D --asexplicit curl readline gnupg pam expac python python2
yay -Syu --asdeps pepper-flash #chromium
yay -Syu --asdeps ebtables dnsmasq bridge-utils #libvirt
yay -Syu --asdeps imagemagick #refind-efi
yay -Syu --asdeps freerdp libvncserver #remmina
yay -Syu --asdeps ffmpegthumbnailer #nemo
yay -Syu --asdeps python-crypto #youtube-dl
yay -Syu --asdeps libmicrodns #vlc
yay -Syu --asdeps xorg-xprop #neofetch
yay -Syu --asdeps coin-or-mp #libreoffice-fresh
yay -Syu --asdeps python2-pyenchant #cherrytree
yay -Syu --asdeps gst-libav #handbrake
yay -Syu --asdeps hugin #digikam
yay -Syu --asdeps gnome-video-effects #cheese
yay -Syu --asdeps atool elinks highlight mediainfo w3m #ranger
#do not use -yu with --asdeps or --asexplicit
sudo systemctl --now enable docker.service paccache.timer libvirtd.service virtlogd.socket
sudo usermod -aG ssh libvirt


yay -Syu gpmdp android-studio cheat-git numix-circle-icon-theme-git paper-icon-theme-git etcher-bin signal gitkraken google-cloud-sdk indicator-sound-switcher rofi-dmenu lastpass polybar-git standardnotes-desktop
#need to install polybar after pulseaudio etc.

yay -Syu avahi nss-mdns
sudo systemctl --now enable avahi-daemon.service avahi-daemon.socket


#later run run-regularly (which runs fix_permissions) to fix permissions more comprehensively.

sudo mkdir -p /media/{nas,gdrive}
sudo chown patricol:patrick /media/{nas,gdrive}/
sudo chmod 770 /media/{nas,gdrive}/

#MORE HARDWARE STUFF:
#Keep checking for when this supports AX860i: https://github.com/audiohacked/OpenCorsairLink
#https://wiki.archlinux.org/index.php/NVIDIA
#Proprietary Drivers:
yay -Syu nvidia vdpauinfo
yay -Syu --asdeps nvidia-settings xorg-server-devel opencl-nvidia
sudo reboot
sudo nvidia-xconfig
#https://wiki.archlinux.org/index.php/NVIDIA#Automatic_configuration
#"If there are instances of DRI, ensure they are commented out"
#nvidia-settings to change settings etc.
#https://wiki.archlinux.org/index.php/Multihead
sudo systemctl --now enable nvidia-persistenced.service
#https://wiki.archlinux.org/index.php/Hardware_video_acceleration
sudo reboot

yay -Syu networkmanager dhclient network-manager-applet
yay -Syu --asdeps dnsmasq strongswan
yay -Syu networkmanager-l2tp
#https://wiki.archlinux.org/index.php/NetworkManager#Mobile_broadband_support
sudo systemctl --now disable dhcpcd.service
#disable the dhcpcd client to replace with this.
sudo systemctl --now enable NetworkManager.service bluetooth.service
sudo reboot

#check pci devices/drivers with "lspci -k"
#test audio/headphones, microphone, and webcam

yay -Syu psensor terminus-font powerline-fonts-git

sudo journalctl --vacuum-size=100M
sudo systemctl restart systemd-journald.service


yay -Syu lightdm lightdm-webkit-theme-aether lightdm-settings
sudo systemctl enable lightdm.service
sudo reboot

sudo systemctl mask hibernate.target suspend-then-hibernate.target hybrid-sleep.target suspend.target sleep.target
#disable hibernation and suspend. Sleep seems to be the same thing. DPMS and "screen blanking" are distinct from all of these.
#this also means there's no reason for me to use caffeine; I was using it to keep the computer from suspending when programs were running.

git clone https://github.com/Patricol/refind-material-theme.git
sudo mount /dev/sdx1 /boot/efi
sudo cp -r ./refind-material-theme/ /boot/efi/EFI/refind/
sudo rm -rf /boot/efi/EFI/refind/refind-material-theme/{src,.git}
rm -rf ./refind-material-theme/
sudo sed -i 's/^\([^#]\)/#\1/g' /boot/efi/EFI/refind/refind.conf
echo -e 'include refind-material-theme/theme.conf' | sudo tee -a /boot/efi/EFI/refind/refind.conf
sudo cp /usr/share/refind/drivers_x64/{btrfs_x64.efi,iso9660_x64.efi,ntfs_x64.efi} /boot/efi/EFI/refind/drivers_x64/
sudo umount /boot/efi

#regarding /etc/pacman.d/hooks/refind.hook, consider consequences of refind-install mounting the wrong efi partition. probably won't happen unless the correct one isn't on /dev/sda?

sudo mkinitcpio -p linux
sudo refind-install
sudo poweroff

#reconnect any other ssds that were disconnected
#power on
#login via tty/ssh
#probably restore home folders now. (use nas filezilla to upload it to arch etc.)
#check what's currently in /home before overwriting etc.
#sudo tar --same-owner -xvpf arch-homes.tar
#login via gui

#verify vdpau hardware acceleration is working by running vdpauinfo

xdpyinfo | grep -B2 resolution
#compare to https://www.sven.de/dpi/
#http://screen-size.info/
#https://wiki.archlinux.org/index.php/Xorg#Display_size_and_DPI

sudo lightdm-settings
gcloud init
add and trust private keys (including journal key) (use gpa)

mkdir /home/che
sudo docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock -v /home/che:/data eclipse/che:latest start
#sudo docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock -v /home/che:/data eclipse/che:latest upgrade

#check that hw acceleration works by using an avd. look at nvidia-settings gpu usage to be sure.
#setup vpn and wifi connections etc. test bluetooth. speakers and file transfer.

setup chrome, deluge, duplicati, nemo, filezilla, gitkraken, atom, gpmdp, pycharm, android studio, quassel, remmina, signal, standard notes, vlc, VMs, i3, che.


#If you didn't copy over files for atom:
#apm install atom-material-ui atom-material-syntax-dark atom-beautify file-icons language-docker angularjs react language-markdown linter linter-pylama linter-clang linter-gcc linter-cpplint advanced-open-file code-peek emmet fonts git-time-machine jumpy minimap sort-lines script todo-show pigments highlight-selected language-smali git-blame color-picker language-autohotkey2 dark-flat-ui
#open atom gui
#close atom gui
#apm disable git-blame color-picker spell-check minimap tree-view

#setup vpn and wifi connections etc. test bluetooth. speakers and file transfer.


use windows computer to update samsung ssd via samsung magician.
https://wiki.archlinux.org/index.php/Google_Authenticator to secure ssh
https://wiki.archlinux.org/index.php/Time#UTC_in_Windows
https://wiki.archlinux.org/index.php/Bash/Prompt_customization
https://wiki.archlinux.org/index.php/Dual_boot_with_Windows#Fast_Start-Up
https://wiki.archlinux.org/index.php/Mouse_acceleration #Handled by libinput with this setup I believe. Seems to be no acceleration by default?


#sets default terminal for nemo to use from right click menu etc.
gsettings set org.cinnamon.desktop.default-applications.terminal exec urxvt
#do that on work account too.

sudo systemctl enable --now run-regularly.timer run-weekly.timer run-on-boot.service
#likely run all of these now


sudo groupadd -r bluetooth
sudo usermod -aG bluetooth patricol
#can remove: /home/secure/config/etc/polkit-1/rules.d/51-blueman.rules
#check: sudo chmod 644 /etc/polkit-1/rules.d/51-blueman.rules

#block access to che except from localhost.
sudo iptables -A INPUT -p tcp -s localhost --dport 8080 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8080 -j DROP


Setup dotfiles if needed: https://github.com/Patricol/dotfiles
