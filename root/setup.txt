* DO BEFORE STARTING:
  * BACKUP HOME FOLDERS
    * sudo tar -cvf /arch-homes.tar /home/
  * CHECK THAT THE SYSTEMFILES REPO IS UP TO DATE AND PUSHED ETC.
    * re-run save-system-info and push the updated package lists

#setup the ec2 instance etc and ssh in. https://www.uplinklabs.net/projects/arch-linux-on-ec2/

timedatectl set-ntp true
pacman -Syu --noconfirm --needed git vim openssh zsh pigz pacman-contrib
git clone -b ec2 --bare https://github.com/Patricol/systemfiles.git /root/systemfiles-repo
alias gsf='git --git-dir=/root/systemfiles-repo --work-tree=/'
alias gsfch='gsf checkout -f ec2 --'
gsf config --local status.showUntrackedFiles no
groupadd patrick
groupadd -r sudo
groupadd -r sudonopass
groupadd -r ssh
groupadd -r docker
usermod -aG ssh root
gsfch /root /usr/local /etc/{local*,sudoers,{locale,makepkg,pacman}.conf,ssh}
locale-gen
mkinitcpio -P
useradd -m -g patrick -G sudo,sudonopass,ssh,docker -s /bin/zsh patricol
passwd patricol

cp -r /root/.ssh /home/patricol
chown -R patricol:patrick /home/patricol/.ssh
fallocate -l 16G /swapfile && chmod 600 /swapfile && mkswap /swapfile && swapon /swapfile
sudo -iu patricol

sudo passwd -l root
sudo mkinitcpio -P
sudo sort-mirrors
git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -sci && cd .. && rm -rf ./yay/

#copy over the old home directory now.
#don't copy to tmp, though; size limit cuts off the file after the transfer completes.
#check what's currently in /home before overwriting etc.
sudo rm -rf /home/*
cd / && sudo tar --same-owner -xvpf /arch-homes.tar

alias gsf='sudo git --git-dir=/root/systemfiles-repo/ --work-tree=/'
yay --needed -Syu $(sudo cat /root/info/packages/explicit.txt)


gsf checkout -f

sudo fix-permissions


Setup dotfiles if needed: https://github.com/Patricol/dotfiles

#exec startx for gui (assuming exec i3 is in ~/.xinitrc)

sudo usermod -aG libvirt patricol

gsettings set org.cinnamon.desktop.default-applications.terminal exec urxvt


sudo systemctl mask hibernate.target suspend-then-hibernate.target hybrid-sleep.target suspend.target sleep.target
sudo systemctl preset-all

sudo journalctl --vacuum-size=100M && sudo systemctl restart systemd-journald.service
sudo mkinitcpio -P
sudo ln -sf /home/patricol/.gitconfig /root/.gitconfig
gsfp --set-upstream origin ec2

reboot

sudo vncpasswd /etc/vncpasswd

#setup chrome, nemo, atom, gpmdp, pycharm, standard notes, VMs, i3, che.

#If you didn't copy over files for atom:
#apm install atom-material-ui atom-material-syntax-dark atom-beautify file-icons language-docker angularjs react language-markdown linter linter-pylama linter-clang linter-gcc linter-cpplint advanced-open-file code-peek emmet fonts git-time-machine jumpy minimap sort-lines script todo-show pigments highlight-selected language-smali git-blame color-picker language-autohotkey2 dark-flat-ui
#open atom gui
#close atom gui
#apm disable git-blame color-picker spell-check minimap tree-view
