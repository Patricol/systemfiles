* DO BEFORE STARTING:
  * CHECK THAT THE SYSTEMFILES REPO IS UP TO DATE AND PUSHED ETC.
    * re-run save-system-info and push the updated package lists


#boot into archiso (UEFI).
#Check that you booted in UEFI mode:
efivar --list
#Check you're connected to the internet:
ping -c 1 1.1.1.1
timedatectl set-ntp true
#Check what disk to use:
fdisk -l
parted
select /dev/sdx
#CHECK THE LIST ABOVE (DO BEFORE STARTING) BEFORE FORMATTING
mklabel gpt
mkpart ESP fat32 1MiB 1025MiB
set 1 esp on
mkpart primary ext4 1025MiB 100%
quit
mkfs.fat -F32 /dev/sdx1
mkfs.ext4 /dev/sdx2
fatlabel /dev/sdx1 "EFI"
e2label /dev/sdx2 "ArchLinux"
mount /dev/sdx2 /mnt
mkdir /mnt/boot
mount /dev/sdx1 /mnt/boot
pacstrap /mnt base base-devel
arch-chroot /mnt
hwclock --systohc
pacman -Syu intel-ucode amd-ucode git vim openssh
# no reason not to install both intel and amd
git clone -b pam --bare https://github.com/Patricol/systemfiles.git /root/systemfiles-repo
alias gsf='git --git-dir=/root/systemfiles-repo --work-tree=/'
alias gsfch='gsf checkout -f pam --'
gsfch /root /usr/local /etc/{local*,locale.conf,hosts,hostname,fstab,sudoers,makepkg.conf,pacman*,ssh}
locale-gen
mkinitcpio -P
passwd
bootctl install
gsfch /boot
#edit the files in /boot/loader/entries if needed.
exit
umount -R /mnt
poweroff
#remove install media

#power on
#login as root
timedatectl set-ntp true
systemctl --now enable dhcpcd sshd
groupadd patrick
groupadd -r sudo
groupadd -r ssh
useradd -m -g patrick -G sudo,ssh -s /bin/bash patricol
passwd patricol
exit
#login as patricol
sudo passwd -l root
# add .ssh/authorized_keys
ip address
exit

#login as patricol (can use ssh this time if desired.)
sudo pacman -Syu pigz pacman-contrib
sudo sh -c 'fallocate -l 64G /swapfile && chmod 600 /swapfile && mkswap /swapfile && swapon /swapfile' #giving lots of extra to scale better as a swarm node
sudo mkinitcpio -P
#handle any warnings thrown by that last command. can safely ignore missing aic94xx, wd719x, and smsmdtv

git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -sci && cd .. && rm -rf ./yay/


alias gsf='sudo git --git-dir=/root/systemfiles-repo/ --work-tree=/'
gsf config --local status.showUntrackedFiles no


sudo sort-mirrors
#ensure /etc/makepkg.conf is checked out before installing the AUR packages, or they'll take an eternity to compress.
yay --needed -Syu $(sudo cat /root/info/packages/explicit.txt)


gsf checkout -f
(checkout -f to force, but first check in what they modify, for posterity and to make it easier to reapply changes on top of newer base configs. when done, remove this notice.)

sudo fix-permissions


sudo systemctl mask hibernate.target suspend-then-hibernate.target hybrid-sleep.target suspend.target sleep.target ctrl-alt-del.target
#disable hibernation and suspend. Sleep seems to be the same thing. DPMS and "screen blanking" are distinct from all of these. Also disable rebooting with ctrl alt del.
#this also means there's no reason for me to use caffeine; I was using it to keep the computer from suspending when programs were running.
sudo systemctl preset-all
sudo journalctl --vacuum-size=100M && sudo systemctl restart systemd-journald.service


git clone -b archnode --bare https://github.com/Patricol/dotfiles.git ~/.dotfiles-repo
alias dfg='git --git-dir=$HOME/.dotfiles-repo/ --work-tree=$HOME'
dfg config --local status.showUntrackedFiles no
dfg checkout -f

exec bash

ln -sf /home/patricol/.gitconfig /root/.gitconfig

dfgp --set-upstream origin archnode
gsfp --set-upstream origin pam

sudo mkinitcpio -P

reboot

